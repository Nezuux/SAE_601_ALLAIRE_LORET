import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import streamlit as st
import plotly.express as px


# Configurer la page Streamlit
st.set_page_config(page_title="ðŸ§‘â€ðŸ’» Analyse des Salaires en Data Science", layout="wide")

st.text("ALLAIRE Mathis & LORET Martin, Groupe D")

# Charger les donnÃ©es
df = pd.read_csv("ds_salaries.csv")

# Titre de l'application
st.title("ðŸ“Š Visualisation des Salaires en Data Science")

# Afficher un aperÃ§u des donnÃ©es
if st.checkbox("Afficher un aperÃ§u des donnÃ©es"):
    st.write(df.head())

# Statistiques descriptives
st.subheader("ðŸ“Œ Statistiques gÃ©nÃ©rales")
st.write(df.describe())

with st.expander("ðŸ’­ Analyse des statistiques gÃ©nÃ©rales"):
    st.markdown("""
    - Le jeu de donnÃ©es contient 3,755 entrÃ©es
    - Les annÃ©es couvertes vont de 2020 Ã  2023
    - La majoritÃ© des donnÃ©es sont de 2022-2023
    - Les donnÃ©es sont bien distribuÃ©es sur la pÃ©riode
    """)

# Distribution des salaires
df_france = df[df["company_location"] == "FR"]
fig1 = px.box(df_france, x="experience_level", y="salary_in_usd", color="experience_level", 
              title="Distribution des salaires par niveau d'expÃ©rience en France")
st.plotly_chart(fig1)


with st.expander("ðŸ’­ Analyse de la distribution des salaires en France"):
    st.markdown("""
    - Les salaires augmentent avec le niveau d'expÃ©rience
    - Les seniors (SE) ont les salaires les plus Ã©levÃ©s
    - On observe une grande dispersion pour les niveaux expÃ©rimentÃ©s
    - Quelques valeurs atypiques sont prÃ©sentes
    """)

# Salaire moyen par catÃ©gorie
st.subheader("ðŸ“Š Salaire moyen par catÃ©gorie")
category = st.selectbox("Choisir une catÃ©gorie", ['experience_level', 'employment_type', 'job_title', 'company_location'])
avg_salary = df.groupby(category)['salary_in_usd'].mean()
st.bar_chart(avg_salary)

with st.expander("ðŸ’­ Analyse des tendances de salaires"):
    st.markdown("""
    - Les salaires varient significativement selon les catÃ©gories
    - Les postes Ã  temps plein sont mieux rÃ©munÃ©rÃ©s
    - Certains pays offrent des salaires nettement supÃ©rieurs
    - Les Data Scientists seniors sont les mieux payÃ©s
    """)

# CorrÃ©lation entre variables numÃ©riques
st.subheader("ðŸ”— CorrÃ©lations entre variables numÃ©riques")
numeric_df = df.select_dtypes(include=[np.number])
correlation_matrix = numeric_df.corr()
fig, ax = plt.subplots(figsize=(10, 8))
sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', ax=ax)
st.pyplot(fig)

with st.expander("ðŸ’­ Analyse des corrÃ©lations"):
    st.markdown("""
    - Certaines variables montrent des corrÃ©lations fortes
    - Le salaire est fortement corrÃ©lÃ© avec le niveau d'expÃ©rience
    - La taille de l'entreprise a un impact modÃ©rÃ© sur les salaires
    """)

# Analyse interactive des variations de salaire
st.subheader("ðŸ“ˆ Ã‰volution des salaires par poste")

top_jobs = df["job_title"].value_counts().head(10).index
df_top_jobs = df[df["job_title"].isin(top_jobs)]
salary_trend = df_top_jobs.groupby(["work_year", "job_title"])["salary_in_usd"].mean().reset_index()

fig4 = px.line(salary_trend, x="work_year", y="salary_in_usd", color="job_title", 
               title="Tendance des salaires pour les 10 postes les plus courants")
fig4.update_xaxes(dtick=1, tickformat="d")
st.plotly_chart(fig4)

with st.expander("ðŸ’­ Analyse des variations de salaire"):
    st.markdown("""
    - Les salaires ont tendance Ã  augmenter au fil des annÃ©es
    - Certains postes montrent une croissance plus rapide
    - La disparitÃ© entre les postes s'accentue avec le temps
    """)

# Salaire mÃ©dian par expÃ©rience et taille d'entreprise
st.subheader("ðŸ“Š Salaire mÃ©dian par expÃ©rience et taille d'entreprise")

median_salary = df.groupby(["experience_level", "company_size"])["salary_in_usd"].median().reset_index()

fig5 = px.bar(median_salary, x="experience_level", y="salary_in_usd", color="company_size",
              title="Salaire mÃ©dian par niveau d'expÃ©rience et taille d'entreprise")
st.plotly_chart(fig5)

with st.expander("ðŸ’­ Analyse des salaires mÃ©dians"):
    st.markdown("""
    - Les grandes entreprises offrent gÃ©nÃ©ralement de meilleurs salaires
    - L'Ã©cart de salaire entre les niveaux d'expÃ©rience est plus marquÃ© dans les grandes entreprises
    - Les petites entreprises montrent moins de variation entre les niveaux
    """)

# Ajout de filtres dynamiques
st.subheader("ðŸŽ›ï¸ Filtrage dynamique des salaires")

salary_range = st.slider("SÃ©lectionnez la plage de salaire", min_value=25000, max_value=175000, value=(25000, 175000))
df_filtered = df[(df["salary_in_usd"] >= salary_range[0]) & (df["salary_in_usd"] <= salary_range[1])]

st.write(f"Nombre d'observations aprÃ¨s filtrage : {len(df_filtered)}")
st.write(df_filtered.head())

with st.expander("ðŸ’­ Analyse du filtrage"):
    st.markdown("""
    - Le filtrage permet d'identifier les segments spÃ©cifiques
    - La majoritÃ© des salaires se situe dans une plage moyenne
    - Certains postes sortent des plages habituelles
    """)

# Impact du tÃ©lÃ©travail sur le salaire selon le pays
st.subheader("ðŸ¡ Impact du tÃ©lÃ©travail sur le salaire selon le pays")

telework_impact = df.groupby(["remote_ratio", "company_location"])["salary_in_usd"].mean().reset_index()

fig6 = px.bar(telework_impact, x="company_location", y="salary_in_usd", color="remote_ratio",
              title="Impact du tÃ©lÃ©travail sur les salaires")
st.plotly_chart(fig6)

with st.expander("ðŸ’­ Analyse de l'impact du tÃ©lÃ©travail"):
    st.markdown("""
    - Le tÃ©lÃ©travail complet offre souvent des salaires plus Ã©levÃ©s
    - L'impact varie selon les pays
    - Certains pays privilÃ©gient le travail hybride
    """)

# Filtrage avancÃ© des donnÃ©es
st.subheader("ðŸ” Filtrage avancÃ©")

exp_levels = st.multiselect("SÃ©lectionnez le niveau d'expÃ©rience", df["experience_level"].unique())
company_sizes = st.multiselect("SÃ©lectionnez la taille d'entreprise", df["company_size"].unique())

df_filtered_advanced = df
if exp_levels:
    df_filtered_advanced = df_filtered_advanced[df_filtered_advanced["experience_level"].isin(exp_levels)]
if company_sizes:
    df_filtered_advanced = df_filtered_advanced[df_filtered_advanced["company_size"].isin(company_sizes)]

st.write(f"Nombre d'observations aprÃ¨s filtrage avancÃ© : {len(df_filtered_advanced)}")
st.write(df_filtered_advanced.head())


with st.expander("ðŸ’­ Analyse des statistiques gÃ©nÃ©rales"):
    st.markdown("""
    - Le jeu de donnÃ©es contient exactement 3,755 entrÃ©es
    - Les annÃ©es couvertes vont de 2020 Ã  2023
    - La moyenne des annÃ©es est d'environ 2022.37, indiquant que la majoritÃ© des donnÃ©es sont rÃ©centes
    - 50% des donnÃ©es se situent en 2022
    - Les donnÃ©es sont principalement concentrÃ©es sur 2022-2023
    - On observe une forte prÃ©sence de profils seniors (SE) dans les donnÃ©es rÃ©centes
    """)

# Top 5 des jobs les mieux payÃ©s
# Grouper par titre de poste et calculer le salaire moyen
job_salaries = df.groupby('job_title')['salary_in_usd'].mean().sort_values(ascending=False)

# SÃ©lectionner le top 5
top_5_jobs = job_salaries.head(5)

# CrÃ©er un DataFrame pour l'affichage
top_5_df = pd.DataFrame({
    'Job Title': top_5_jobs.index,
    'Average Salary (USD)': top_5_jobs.values
})

# Afficher le tableau dans Streamlit
st.subheader("Top 5 des jobs les mieux payÃ©s")
st.table(top_5_df)

with st.expander("ðŸ’­ Analyse des jobs les mieux payÃ©s"):
    st.markdown("""
    - On retrouve le job Data Science Tech Lead qui est le mieux payÃ©
    - Le job Data Science Tech Lead est 1,9 fois plus payÃ© que Principal Data Scientist
    - Il y a beaucoup de diffÃ©rence entre les salaires
    """)